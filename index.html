<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Averaging Bitcoin</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" media="screen,projection">
    <style>
        .tabs .tab a:hover, .tabs .tab a.active {
            background-color: transparent;
            color: black;
        }

        .tabs .tab a {
            color: black;
        }

        .tabs .indicator {
            background-color: black;
        }
    </style>
</head>
<body>
    <div class="center">
        <div class="container">
            <h1 class="flow-text"><strong><span id="currency-display-name">South African Rand</span> Cost Averaging Bitcoin</strong></h1>
            <p id="summary-1" class="flow-text"></p>
            <div class="center">
                <a class="btn blue" href="javascript:copySummary()">Copy Summary</a>
            </div>
            <div class="row"></div>
        </div>
        
        <div class="row">
            <div class="col s12">
                <div class="row">
                    <div class="col s12 m4">
                        <div class="card">
                            <div class="card-content">
                                <span id="total-saved" class="card-title">...</span>
                                <p>Total Fiat Saved</p>
                            </div>
                        </div>
                        
                    </div>
                    <div class="col s12 m4">
                        <div class="card">
                            <div class="card-content">
                                <span id="btc-accumulated" class="card-title">...</span>
                                <p>Total Bitcoin Accumulated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col s12 m4">
                        <div class="card">
                            <div class="card-content">
                                <span id="current-fiat-value" class="card-title">...</span>
                                <p>Current Fiat Trade Value</p>
                            </div>
                        </div>
                    </div>
                    <div class="col s6">
                        <div class="card">
                            <div class="card-content">
                                <span id="multiple-change" class="card-title">...</span>
                                <p>Multiples</p>
                            </div>
                        </div>
                    </div>
                    <div class="col s6">
                        <div class="card">
                            <div class="card-content">
                                <span id="percent-change" class="card-title">...</span>
                                <p>Percent Change</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="divider"></div>

        <div class="container">
            <p id="summary-2" class="flow-text"></p>
            <div class="center">
                <a class="btn blue" href="javascript:copySummary()">Copy Summary</a>
            </div>
            <div class="row"></div>
        </div>
        
        <div class="divider"></div>

        <div class="container">
            <div class="row">
            </div>
            <div class="row">
                <div class="col s12">
                    <ul class="tabs">
                        <li class="tab col s6"><a href="#recurring-section">Recurring</a></li>
                        <li class="tab col s6"><a href="#once-off-section">Once Off</a></li>
                    </ul>
                </div>
                <div id="recurring-section" class="col s12">
                    <div class="row">
                    </div>
                    <form id="form" class="row" action="get">
                        <div class="input-field col s12 m4">
                            <select id="currency" class="currency-select" name="currency" onchange="updateCurrency()">
                            </select>
                            <label for="currency">Currency</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <label>Amount to Save</label>
                            <input id="dca-amount" type="number" class="validate" value="10" min="10" step="1" name="dca-amount" oninput="updateRecurringCalculation()">
                        </div>
                        <div class="input-field col s12 m4">
                            <select id="frequency" name="frequency" onchange="updateRecurringCalculation()">
                                <option value="1">Daily</option>
                                <option value="7">Weekly</option>
                                <option value="30">Monthly</option>
                                <option value="365">Yearly</option>
                            </select>
                            <label for="frequency">Frequency of saving</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="months-ago" name="months-ago" onchange="updateRecurringCalculation()">
                                <option value="1">1 Month</option>
                                <option value="2">2 Months</option>
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12">1 Year Ago</option>
                                <option value="24">2 Years Ago</option>
                                <option value="36">3 Years Ago</option>
                                <option value="48">4 Years Ago</option>
                                <option value="60">5 Years Ago</option>
                                <option value="72">6 Years Ago</option>
                                <option value="84">7 Years Ago</option>
                                <option value="96">8 Years Ago</option>
                                <option value="108">9 Years Ago</option>
                            </select>
                            <label for="months-ago">Starting Date</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="months-duration" name="months-duration" onchange="updateRecurringCalculation()"> 
                                <option value="1">1 Month</option>
                                <option value="2">2 Months</option>
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12">1 Year</option>
                                <option value="24">2 Years</option>
                                <option value="36">3 Years</option>
                                <option value="48">4 Years</option>
                                <option value="60">5 Years</option>
                                <option value="72">6 Years</option>
                                <option value="84">7 Years</option>
                                <option value="96">8 Years</option>
                                <option value="108">9 Years</option>
                            </select>
                            <label for="months-duration">Accumulate For</label>
                        </div>
        
                        <div class="center">
                            <a class="btn blue" href="javascript:copyURL('form')">Copy URL</a>
                        </div>
                    </form>
                </div>
                <div id="once-off-section" class="col s12">
                    <div class="row">
                    </div>
                    <form id="once-off-form" class="row" action="get">
                        <input type="hidden" name="frequency" value="0">
                        <div class="input-field col s12 m4">
                            <select id="once-off-currency" class="currency-select" name="currency" onchange="updateCurrency()">
                            </select>
                            <label for="once-off-currency">Currency</label>
                        </div>
                        <div class="input-field col s12 m4">
                            <label>Amount to Save</label>
                            <input id="once-off-amount" type="number" class="validate" value="10" min="10" step="1" name="once-off-amount" oninput="updateOnceOffCalculation()">
                        </div>
                        <div class="input-field col s12 m4">
                            <input id="starting-date" name="starting-date" type="text" class="datepicker" placeholder="Date of Purchase">
                        </div>
                        <div class="center">
                            <a class="btn blue" href="javascript:copyURL('once-off-form')">Copy URL</a>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>

    <footer class="page-footer grey">
        <div class="container">
            <div class="row">
                <div class="col s12">
                    <h5 class="white-text">Cost Averaging Bitcoin</h5>
                    <p>Price information taking from the Luno exchange.</p>
                    <ul>
                        <li><a class="white-text" href="https://github.com/exonumia-cc/cabtc">Github</a></li>
                        <li><a class="white-text" href="https://exonumia.cc">Exonumia</a></li>
                      </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                © 2021
                <a class="white-text" href="https://sigidli.com">Sigidli</a>
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        const supportedCurrencies = {
            'ZAR': {
                ticker: "ZAR",
                name: "South African Rand",
                symbol: 'R'
            },
            'NAD': {
                ticker: "ZAR",
                name: "Namibian Dollar",
                symbol: 'N$'
            },
            'SZL': {
                ticker: "ZAR",
                name: "Swazi Lilangeni",
                symbol: 'E'
            },
            'ZMW': {
                ticker: "ZMW",
                name: "Zambian Kwacha",
                symbol: 'ZK'
            },
            'LSL': {
                ticker: "ZAR",
                name: "Lesotho loti",
                symbol: 'M'
            },
            'NGN': {
                ticker: "NGN",
                name: "Nigerian Naira",
                symbol: '₦'
            },
            'UGX': {
                ticker: "UGX",
                name: "Ugandan Shilling",
                symbol: 'USh'
            },
        }

        var priceHistory
        var frequency
        var currencyTicker = supportedCurrencies[window.location.hostname.substring(0,3).toUpperCase()] ? window.location.hostname.substring(0,3).toUpperCase() : 'ZAR'
        const urlParams = new URLSearchParams(window.location.search);


        document.addEventListener('DOMContentLoaded', function() {
            initForm()

            var elems = document.querySelectorAll('select');
            var instances = M.FormSelect.init(elems, {});

            var tabs = document.querySelectorAll('.tabs');
            var tabInstances = M.Tabs.init(tabs, {
                onShow: function () {
                    if (priceHistory && tabInstances[0].index == 1) {
                        updateOnceOffCalculation()
                    } else if (priceHistory) {
                        updateRecurringCalculation()
                    }
                }
            });

            if (urlParams.get('frequency') == 0) {
                frequency = 0
                tabInstances[0].select('once-off-section')
            }

            var datePicker = document.querySelectorAll('.datepicker');

            var purchaseDate = new Date()
            var urlParamsStartingDate = new Date(urlParams.get('starting-date'))
            if (urlParams.get('starting-date') && !isNaN(urlParamsStartingDate.getTime())) {
                purchaseDate = new Date(urlParams.get('starting-date'))
            } else {
                purchaseDate.setMonth(purchaseDate.getMonth() - 12)
            }
            
            var dataPickerInstances = M.Datepicker.init(datePicker, {
                autoClose: true,
                defaultDate: purchaseDate,
                setDefaultDate: true,
                minDate: new Date(1365811200000),
                onSelect: updateOnceOffCalculation
            });

            updateCurrency()
        });
        
        const initForm = function() {
            
            if (supportedCurrencies[urlParams.get('currency')]) {
                currencyTicker = urlParams.get('currency') 
            }

            // Init recurring params
            document.getElementById('dca-amount').value = Number(urlParams.get('dca-amount')) || 10
            document.getElementById('frequency').value = Number(urlParams.get('frequency')) || 1
            document.getElementById('months-ago').value = Number(urlParams.get('months-ago')) || 12
            document.getElementById('months-duration').value = Number(urlParams.get('months-duration')) || 12

            // Init once off params
            document.getElementById('once-off-amount').value = Number(urlParams.get('once-off-amount')) || 10

            var currencySelects = document.querySelectorAll(".currency-select");

            currencySelects.forEach(currencySelect => {
                Object.keys(supportedCurrencies).sort().forEach(key => {
                    var option = document.createElement("option");
                    option.text = supportedCurrencies[key].name;
                    option.value = key
                    option.selected = key == currencyTicker
                    currencySelect.add(option);
                })
            })   
        }

        const updateCurrency = function () {

            var currencySelect = document.getElementById(frequency == 0 ? "once-off-currency" : "currency");
            currencyTicker = currencySelect.value || 'ZAR'
            const priceHistoryURL = `https://ajax.luno.com/ajax/1/udf/history?symbol=XBT${supportedCurrencies[currencyTicker].ticker}&resolution=1D&from=1365811200&to=${Math.floor(new Date().getTime()/1000)}`
            document.getElementById('currency-display-name').innerHTML = supportedCurrencies[currencyTicker].name

            var currencySelects = document.querySelectorAll(".currency-select");

            currencySelects.forEach(currencySelect => {
                for (const i of Array(currencySelect.options.length).keys()) {
                    const option = currencySelect.options[i]
                    if (option.value == currencyTicker) {
                        // currencySelect.value = option.value
                        currencySelect.selectedIndex = i
                    }
                }
            }) 

            fetch(priceHistoryURL, {
                "credentials": "omit",
                "method": "GET",
                "mode": "cors"
            }).then(response => {
                return response.json()
            }).then(freshPriceHistory => {
                if (freshPriceHistory.s == "ok") {
                    priceHistory = freshPriceHistory

                    if (frequency == 0) {
                        updateOnceOffCalculation()
                    } else {
                        updateRecurringCalculation()
                    }
                }
            })
        }

        const updateOnceOffCalculation = function (updatedDate) {
            const dcaAmount = Number(document.getElementById('once-off-amount').value) || 10
            frequency = 0

            var startingDate = updatedDate || new Date(document.getElementById('starting-date').value) || new Date()

            var endingDate = new Date(startingDate)
            endingDate.setDate(endingDate.getDate() + 1)

            calculateBTCAccumalated(dcaAmount, startingDate, endingDate)
        }
        
        const updateRecurringCalculation = function () {
            const dcaAmount = Number(document.getElementById('dca-amount').value) || 10
            frequency = Number(document.getElementById('frequency').value) || 1

            const startingMonth = Number(document.getElementById('months-ago').value) || 12
            var startingDate = new Date()
            startingDate.setMonth(startingDate.getMonth() - startingMonth)

            const endingMonth = Number(document.getElementById('months-duration').value) || 12
            var endingDate = new Date(startingDate)
            endingDate.setMonth(endingDate.getMonth() + endingMonth)

            calculateBTCAccumalated(dcaAmount, startingDate, endingDate)
        }

        const calculateBTCAccumalated = function (recurringAmount, startingDate, endingDate) {
            var fiatSaved = 0
            var btcAccumulated = 0

            priceHistory.o.forEach((priceAtOpen, index) => {
                const priceDate = new Date(priceHistory.t[index] * 1000)
                if ((frequency == 0 || index%frequency == 0) && priceDate > startingDate && priceDate < endingDate) {
                    fiatSaved += recurringAmount
                    btcAccumulated += recurringAmount/priceAtOpen
                }
            });

            currentValue = Number(Number(btcAccumulated*priceHistory.o[priceHistory.o.length-1]).toFixed(2))

            const totalFiatSavedString = `${supportedCurrencies[currencyTicker].symbol}${fiatSaved.toLocaleString()}`
            // const totalBitcoinAccumulatedString = `${Number(btcAccumulated.toFixed(8)).toLocaleString("za").replace(",",".")} BTC`
            const totalBitcoinAccumulatedString = `${btcAccumulated.toFixed(8)} BTC`
            const currentFiatTradeValueString = `${supportedCurrencies[currencyTicker].symbol}${currentValue.toLocaleString()}`
            const multipleChangeString = `${Number(currentValue/fiatSaved).toLocaleString()}x`
            const percentChanceString = `${Number((currentValue/fiatSaved*100)-100).toFixed(2)}% ${currentValue>fiatSaved ? "increase" : "decrease"}`

            const frequencyString = frequency == 0 ? ` on the ${startingDate.toLocaleDateString()}` : `${document.getElementById('frequency').selectedOptions[0].text.toLowerCase()} from ${startingDate.toLocaleDateString()} until ${endingDate.toLocaleDateString()}`

            document.getElementById("total-saved").innerHTML = totalFiatSavedString
            document.getElementById("btc-accumulated").innerHTML = totalBitcoinAccumulatedString
            document.getElementById("current-fiat-value").innerHTML = currentFiatTradeValueString
            document.getElementById("multiple-change").innerHTML = multipleChangeString
            document.getElementById("percent-change").innerHTML = percentChanceString
            
            document.getElementById("summary-1").innerHTML = `Saving ${supportedCurrencies[currencyTicker].symbol}${recurringAmount} in Bitcoin ${frequencyString} might have got you ${totalBitcoinAccumulatedString}.\n\nToday that ${totalFiatSavedString} would be worth ${currentFiatTradeValueString} (${percentChanceString})`
            document.getElementById("summary-2").innerHTML = document.getElementById("summary-1").innerHTML     
        }

        const copySummary = function () {
            const url = getURL()
            navigator.clipboard.writeText(`${document.getElementById("summary-1").textContent}\n\n${url}` )
            M.toast({html: 'copied'})
        }

        const copyURL = function () {
            const url = getURL()
            navigator.clipboard.writeText(url)
            M.toast({html: 'copied'})
        }

        const getURL = function () {
            const form = document.getElementById(frequency == 0 ? 'once-off-form' : 'form')
            const searchData = new URLSearchParams(new FormData(form))

            const url = `${window.location.protocol}//${window.location.hostname}${window.location.pathname}?${searchData.toString()}`

            return url
        }
    </script>
</body>
</html>
